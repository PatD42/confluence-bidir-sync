# conf-sync-001: File Plan
#
# This document describes the intent and responsibility of each file
# created or modified in Epic 001: Confluence API Integration & Surgical Updates.
#
# BMAD Phase: Phase 2 - Context-Engineered Development
# Agent Role: Architect
# Created During: Architecture Phase - File Planning

---

epic_id: conf-sync-001
epic_title: Confluence API Integration & Surgical Updates
status: complete

# =============================================================================
# SOURCE FILES
# =============================================================================

source_files:

  # ---------------------------------------------------------------------------
  # Confluence Client Module (API Layer)
  # ---------------------------------------------------------------------------

  - path: src/confluence_client/__init__.py
    intent: Public exports for confluence_client module
    exports:
      - APIWrapper
      - Authenticator
      - ConfluenceError
      - InvalidCredentialsError
      - PageNotFoundError
      - PageAlreadyExistsError
      - VersionConflictError
      - APIUnreachableError
      - APIAccessError
      - retry_on_rate_limit
    dependencies: []

  - path: src/confluence_client/api_wrapper.py
    intent: HTTP client wrapping atlassian-python-api with error translation
    responsibilities:
      - Wrap Confluence REST API v2 calls
      - Translate HTTP errors to typed exceptions
      - Apply retry logic for rate limits
      - Provide CRUD operations (get, create, update, delete)
    public_api:
      - APIWrapper.__init__(authenticator)
      - APIWrapper.get_page_by_id(page_id, expand)
      - APIWrapper.get_page_by_title(space, title, expand)
      - APIWrapper.get_child_pages(page_id, expand)
      - APIWrapper.create_page(space, title, body, parent_id)
      - APIWrapper.update_page(page_id, title, body, version)
      - APIWrapper.delete_page(page_id)
    dependencies:
      - atlassian-python-api
      - auth.py
      - errors.py
      - retry_logic.py
    tests: tests/unit/test_api_wrapper.py

  - path: src/confluence_client/auth.py
    intent: Load and validate Confluence credentials from environment
    responsibilities:
      - Load credentials from .env file
      - Validate required fields present
      - Provide credentials to APIWrapper
    public_api:
      - Authenticator.__init__()
      - Authenticator.url
      - Authenticator.email
      - Authenticator.api_token
    dependencies:
      - python-dotenv
    tests: tests/unit/test_auth.py
    security_notes:
      - Never log credentials
      - Never include credentials in error messages

  - path: src/confluence_client/errors.py
    intent: Typed exception hierarchy for Confluence operations
    responsibilities:
      - Define base ConfluenceError
      - Define 6 specific error types with actionable attributes
      - Enable precise exception handling
    exceptions:
      - ConfluenceError (base)
      - InvalidCredentialsError (401)
      - PageNotFoundError (404)
      - PageAlreadyExistsError (duplicate title)
      - VersionConflictError (409)
      - APIUnreachableError (network)
      - APIAccessError (other)
      - ConversionError (Pandoc)
    dependencies: []
    tests: tests/unit/test_errors.py

  - path: src/confluence_client/retry_logic.py
    intent: Exponential backoff retry for rate-limited requests
    responsibilities:
      - Detect 429 responses
      - Implement exponential backoff (1s, 2s, 4s)
      - Respect Retry-After header
      - Fail after max retries
    public_api:
      - retry_on_rate_limit(func, *args, **kwargs)
      - @as_decorator
    dependencies: []
    tests: tests/unit/test_retry_logic.py

  # ---------------------------------------------------------------------------
  # Content Converter Module
  # ---------------------------------------------------------------------------

  - path: src/content_converter/__init__.py
    intent: Public exports for content_converter module
    exports:
      - MarkdownConverter
      - ConversionError
    dependencies: []

  - path: src/content_converter/markdown_converter.py
    intent: Bidirectional XHTML-markdown conversion via Pandoc
    responsibilities:
      - Convert XHTML to markdown (for agents/editing)
      - Convert markdown to XHTML (for Confluence upload)
      - Handle Pandoc subprocess safely
    public_api:
      - MarkdownConverter.xhtml_to_markdown(xhtml)
      - MarkdownConverter.markdown_to_xhtml(markdown)
    dependencies:
      - Pandoc CLI (external)
    tests: tests/unit/test_markdown_converter.py
    security_notes:
      - No shell=True in subprocess
      - Timeout on subprocess calls

  # ---------------------------------------------------------------------------
  # Page Operations Module (Surgical Updates)
  # ---------------------------------------------------------------------------

  - path: src/page_operations/__init__.py
    intent: Public exports for page_operations module
    exports:
      - PageOperations
      - SurgicalEditor
      - ContentParser
      - PageSnapshot
      - SurgicalOperation
      - OperationType
      - BlockType
      - ContentBlock
      - UpdateResult
      - CreateResult
    dependencies: []

  - path: src/page_operations/models.py
    intent: Data classes for page operations
    responsibilities:
      - Define PageSnapshot (complete page state)
      - Define SurgicalOperation (single change)
      - Define OperationType enum
      - Define BlockType enum
      - Define ContentBlock (parsed element)
      - Define UpdateResult/CreateResult
    data_classes:
      - PageSnapshot
      - SurgicalOperation
      - OperationType
      - BlockType
      - ContentBlock
      - UpdateResult
      - CreateResult
      - PageVersion
    dependencies: []
    tests: tests/unit/test_models.py

  - path: src/page_operations/page_operations.py
    intent: High-level orchestration for page read/write/create
    responsibilities:
      - Fetch page with both XHTML and markdown (PageSnapshot)
      - Apply surgical operations to XHTML
      - Create new pages from markdown
      - Handle version conflicts
    public_api:
      - PageOperations.__init__(api_wrapper, converter)
      - PageOperations.get_page_snapshot(page_id, version)
      - PageOperations.get_page_versions(page_id)
      - PageOperations.apply_operations(page_id, base_xhtml, base_version, operations)
      - PageOperations.create_page(space_key, title, markdown, parent_id, check_duplicate)
    dependencies:
      - api_wrapper.py
      - markdown_converter.py
      - surgical_editor.py
      - models.py
    tests: tests/e2e/test_*.py

  - path: src/page_operations/surgical_editor.py
    intent: Apply discrete operations to XHTML without touching macros
    responsibilities:
      - Parse XHTML with BeautifulSoup
      - Apply UPDATE_TEXT operation
      - Apply DELETE_BLOCK operation
      - Apply INSERT_BLOCK operation
      - Apply CHANGE_HEADING_LEVEL operation
      - Apply TABLE_INSERT_ROW operation
      - Apply TABLE_DELETE_ROW operation
      - Never modify ac: namespace elements
    public_api:
      - SurgicalEditor.apply(xhtml, operations)
      - SurgicalEditor.count_macros(xhtml)
    dependencies:
      - BeautifulSoup4
      - lxml
      - models.py
    tests: tests/unit/test_surgical_editor.py
    key_constraint: NEVER modify elements with ac: namespace prefix

  - path: src/page_operations/content_parser.py
    intent: Extract content blocks from XHTML for analysis
    responsibilities:
      - Parse XHTML into discrete blocks
      - Identify block types (HEADING, PARAGRAPH, TABLE, etc.)
      - Preserve element references for surgical operations
      - Handle Confluence-specific markup
    public_api:
      - ContentParser.parse(xhtml)
      - ContentParser.extract_blocks(xhtml)
    dependencies:
      - BeautifulSoup4
      - lxml
      - models.py
    tests: tests/unit/test_content_parser.py

  # ---------------------------------------------------------------------------
  # Shared Models
  # ---------------------------------------------------------------------------

  - path: src/models/__init__.py
    intent: Public exports for models module
    exports:
      - ConfluencePage
      - ConversionResult
    dependencies: []

  - path: src/models/confluence_page.py
    intent: Data class representing a Confluence page
    data_class: ConfluencePage
    attributes:
      - page_id: str
      - space_key: str
      - title: str
      - content_storage: str
      - version: int
      - labels: List[str]
      - parent_id: Optional[str]
      - children: List[str]
    dependencies: []

  - path: src/models/conversion_result.py
    intent: Data class for conversion operation results
    data_class: ConversionResult
    attributes:
      - markdown: str
      - metadata: Dict[str, Any]
      - warnings: List[str]
    dependencies: []

# =============================================================================
# TEST FILES
# =============================================================================

test_files:

  # ---------------------------------------------------------------------------
  # Unit Tests
  # ---------------------------------------------------------------------------

  - path: tests/unit/test_api_wrapper.py
    tests_for: src/confluence_client/api_wrapper.py
    test_count: 25
    coverage_target: 90%

  - path: tests/unit/test_auth.py
    tests_for: src/confluence_client/auth.py
    test_count: 8
    coverage_target: 90%

  - path: tests/unit/test_errors.py
    tests_for: src/confluence_client/errors.py
    test_count: 15
    coverage_target: 100%

  - path: tests/unit/test_retry_logic.py
    tests_for: src/confluence_client/retry_logic.py
    test_count: 12
    coverage_target: 90%

  - path: tests/unit/test_markdown_converter.py
    tests_for: src/content_converter/markdown_converter.py
    test_count: 20
    coverage_target: 85%

  - path: tests/unit/test_surgical_editor.py
    tests_for: src/page_operations/surgical_editor.py
    test_count: 18
    coverage_target: 90%
    key_tests:
      - test_update_text_replaces_content
      - test_delete_block_removes_element
      - test_insert_block_adds_paragraph
      - test_change_heading_level
      - test_table_insert_row
      - test_table_delete_row
      - test_macro_elements_never_modified

  - path: tests/unit/test_content_parser.py
    tests_for: src/page_operations/content_parser.py
    test_count: 20
    coverage_target: 90%

  - path: tests/unit/test_macro_preserver.py
    tests_for: tests/helpers/macro_test_utils.py
    test_count: 10
    note: Tests for OLD approach (HTML comments), kept for fetch journey verification

  # ---------------------------------------------------------------------------
  # E2E Tests
  # ---------------------------------------------------------------------------

  - path: tests/e2e/test_confluence_fetch_journey.py
    journey: Fetch page → convert to markdown → verify
    test_count: 4
    requires: Confluence Cloud access

  - path: tests/e2e/test_confluence_push_journey.py
    journey: Markdown → XHTML → create/update page → verify
    test_count: 6
    requires: Confluence Cloud access

  - path: tests/e2e/test_surgical_update_journey.py
    journey: Get snapshot → apply operations → verify preservation
    test_count: 10
    requires: Confluence Cloud access
    key_validations:
      - Macro count unchanged after operations
      - Local-id attributes preserved
      - Version incremented correctly

  # ---------------------------------------------------------------------------
  # Test Helpers
  # ---------------------------------------------------------------------------

  - path: tests/helpers/confluence_test_setup.py
    intent: Setup/teardown utilities for E2E tests
    functions:
      - setup_test_page(space_key, title, content) -> page_id
      - teardown_test_page(page_id)

  - path: tests/helpers/macro_test_utils.py
    intent: MacroPreserver for verifying macro survival in E2E tests
    note: Uses OLD HTML comment approach; only for test verification
    functions:
      - MacroPreserver.extract_macros(xhtml)
      - MacroPreserver.restore_macros(content, macros)

  # ---------------------------------------------------------------------------
  # Fixtures
  # ---------------------------------------------------------------------------

  - path: tests/fixtures/sample_pages.py
    intent: Pre-built XHTML samples for testing
    samples:
      - MINIMAL_XHTML
      - PAGE_WITH_MACRO
      - PAGE_WITH_LOCAL_IDS
      - COMPLEX_PAGE

  - path: tests/fixtures/sample_markdown.py
    intent: Pre-built markdown samples for testing

  - path: tests/fixtures/confluence_credentials.py
    intent: Load test credentials from .env.test

# =============================================================================
# REMOVED FILES (Consolidation)
# =============================================================================

removed_files:

  - path: src/confluence_client/page_fetcher.py
    reason: Thin wrapper with no added value
    replacement: Use APIWrapper.get_page_by_id() directly

  - path: src/confluence_client/page_updater.py
    reason: Thin wrapper with no added value
    replacement: Use APIWrapper.update_page() directly

  - path: src/confluence_client/page_creator.py
    reason: Thin wrapper with no added value
    replacement: Use APIWrapper.create_page() directly

  - path: src/content_converter/xhtml_parser.py
    reason: Thin wrapper around BeautifulSoup
    replacement: Use BeautifulSoup(xhtml, 'lxml') directly

  - path: src/content_converter/macro_preserver.py
    reason: HTML comment approach superseded by surgical updates
    replacement: Moved to tests/helpers/macro_test_utils.py for E2E test verification

  - path: tests/unit/test_page_operations.py
    reason: Old mock-based tests superseded by E2E tests
    replacement: tests/e2e/test_*.py

  - path: tests/unit/test_xhtml_parser.py
    reason: Tested removed xhtml_parser.py
    replacement: Not needed; BeautifulSoup doesn't need wrapper tests

# =============================================================================
# CONFIGURATION FILES
# =============================================================================

config_files:

  - path: requirements.txt
    intent: Production dependencies with pinned versions

  - path: requirements-test.txt
    intent: Test dependencies

  - path: .env.example
    intent: Template for required environment variables
    variables:
      - CONFLUENCE_URL
      - CONFLUENCE_EMAIL
      - CONFLUENCE_API_TOKEN

# =============================================================================
# METRICS
# =============================================================================

metrics:
  total_source_files: 11
  total_test_files: 11
  total_tests: 159
  coverage: 87%
  removed_files: 7
