epic_id: CONF-SYNC-007
title: Comprehensive Test Coverage

stories:
  - id: STORY-007-01
    title: ADF Surgical Update E2E Tests
    points: 5
    files_to_create:
      - path: tests/e2e/test_adf_surgical_e2e.py
        intent: |
          WHAT: E2E tests verifying ADF surgical update path with real Confluence.
          WHY: Validate that edits use ADF API with hardBreak nodes, not XHTML storage. Critical for data integrity.
          RESPONSIBILITIES: Test ADF path selection, hardBreak conversion, TABLE_UPDATE_CELL operations, multi-edit scenarios.
          DEPENDENCIES: Requires test_credentials fixture, cleanup_test_pages, synced page setup helpers.
          RELATED MODULES: Uses src/page_operations/adf_editor.py, src/confluence_client/api_wrapper.py

  - id: STORY-007-02
    title: Line Break Format Conversion E2E Tests
    points: 3
    files_to_create:
      - path: tests/e2e/test_line_break_roundtrip_e2e.py
        intent: |
          WHAT: E2E tests for full <p> → <br> → <p> round-trip through sync cycles.
          WHY: Ensure line breaks in table cells survive pull/push without data loss. User-facing data integrity.
          RESPONSIBILITIES: Test pull conversion, push conversion, bidirectional edit preservation, multiple BR handling.
          DEPENDENCIES: Requires MarkdownConverter, SyncCommand, Confluence pages with <p> tags in cells.
          RELATED MODULES: Uses src/content_converter/markdown_converter.py, test_three_way_merge.py patterns

  - id: STORY-007-03
    title: Conflict Resolution E2E Tests
    points: 5
    files_to_create:
      - path: tests/e2e/test_conflict_markers_e2e.py
        intent: |
          WHAT: E2E tests for conflict detection and marker output in real sync scenarios.
          WHY: Users must see clear conflict markers to manually resolve. Critical UX for bidirectional sync.
          RESPONSIBILITIES: Test same-cell conflict markers, same-row auto-merge, paragraph conflicts, resolved sync.
          DEPENDENCIES: Requires concurrent edit simulation, SyncCommand, conflict resolution workflow.
          RELATED MODULES: Uses src/git_integration/conflict_resolver.py, src/git_integration/table_merge.py

  - id: STORY-007-04
    title: Macro Preservation E2E Tests
    points: 3
    files_to_create:
      - path: tests/e2e/test_macro_preservation_e2e.py
        intent: |
          WHAT: E2E tests ensuring Confluence macros survive full sync cycle.
          WHY: Macros are critical Confluence functionality. Corruption causes data loss and user frustration.
          RESPONSIBILITIES: Test TOC macro, code macro, inline macro preservation through pull/edit/push.
          DEPENDENCIES: Requires pages with ac: namespace elements, macro counting, full sync workflow.
          RELATED MODULES: Uses src/page_operations/adf_editor.py count_macros, test_surgical_edit.py patterns

  - id: STORY-007-05
    title: ConflictResolver Integration Tests
    points: 3
    files_to_create:
      - path: tests/integration/test_conflict_resolver_integration.py
        intent: |
          WHAT: Integration tests for ConflictResolver + TableMerge component interaction.
          WHY: Verify cell-level merge routing works correctly without hitting real Confluence API.
          RESPONSIBILITIES: Test table region routing to TableMerge, non-table to merge3, mixed content handling.
          DEPENDENCIES: Requires mocked baseline content, ConflictResolver, TableMerge.
          RELATED MODULES: Uses src/git_integration/conflict_resolver.py, src/git_integration/table_merge.py

  - id: STORY-007-06
    title: ADF Path Selection Integration Tests
    points: 3
    files_to_create:
      - path: tests/integration/test_adf_path_selection.py
        intent: |
          WHAT: Integration tests for ADF vs XHTML format selection in PageOperations.
          WHY: Ensure correct API path is chosen based on page format and operation type.
          RESPONSIBILITIES: Test ADF path selection, surgical update routing, ADF failure fallback.
          DEPENDENCIES: Requires mocked APIWrapper, PageOperations, format detection.
          RELATED MODULES: Uses src/page_operations/page_operations.py, src/page_operations/adf_editor.py

  - id: STORY-007-07
    title: Version Conflict Integration Tests
    points: 3
    files_to_create:
      - path: tests/integration/test_version_conflict_handling.py
        intent: |
          WHAT: Integration tests for version conflict detection and recovery during sync.
          WHY: Race conditions can cause data loss. Must handle version changes gracefully.
          RESPONSIBILITIES: Test version mismatch detection, retry logic, persistent conflict reporting.
          DEPENDENCIES: Requires mocked API with version changes, SyncCommand, error handling.
          RELATED MODULES: Uses src/confluence_client/api_wrapper.py, src/cli/sync_command.py

  - id: STORY-007-08
    title: ADF Fallback E2E Tests
    points: 3
    files_to_create:
      - path: tests/e2e/test_adf_fallback_e2e.py
        intent: |
          WHAT: E2E tests for graceful fallback when ADF surgical updates fail.
          WHY: Ensure system degrades gracefully to full replacement when surgical fails.
          RESPONSIBILITIES: Test >50% failure fallback, API error fallback, fallback content verification.
          DEPENDENCIES: Requires error injection, fallback path monitoring, full sync verification.
          RELATED MODULES: Uses src/page_operations/page_operations.py fallback logic

  - id: STORY-007-09
    title: Baseline Manager Integration Tests
    points: 2
    files_to_create:
      - path: tests/integration/test_baseline_merge_integration.py
        intent: |
          WHAT: Integration tests for baseline usage in actual 3-way merge operations.
          WHY: Baseline is source of truth for merge. Must verify it's used correctly.
          RESPONSIBILITIES: Test baseline retrieval for merge, missing baseline handling, baseline refresh.
          DEPENDENCIES: Requires BaselineManager, ConflictResolver, merge workflow mocks.
          RELATED MODULES: Uses src/cli/baseline_manager.py, src/git_integration/conflict_resolver.py

  - id: STORY-007-10
    title: Error Recovery Integration Tests
    points: 2
    files_to_create:
      - path: tests/integration/test_error_recovery.py
        intent: |
          WHAT: Integration tests for error recovery paths across sync operations.
          WHY: Errors are inevitable. Must ensure graceful handling without data loss.
          RESPONSIBILITIES: Test network error retry, partial sync commit, merge failure marker writing.
          DEPENDENCIES: Requires error injection, retry logic, partial commit verification.
          RELATED MODULES: Uses src/cli/sync_command.py, src/confluence_client/api_wrapper.py retry logic

files_to_modify:
  - path: tests/e2e/conftest.py
    intent: |
      WHAT: Add shared fixtures for new E2E tests.
      WHY: Reduce code duplication across new test files.
      CHANGES: Add synced_test_page fixture, ADF API mocks, conflict simulation helpers.

  - path: tests/integration/conftest.py
    intent: |
      WHAT: Add shared fixtures for new integration tests.
      WHY: Standardize mocking patterns and test setup.
      CHANGES: Add mock_api_wrapper, mock_adf_api, baseline_manager fixtures.

  - path: pytest.ini
    intent: |
      WHAT: Configure new test markers and coverage settings.
      WHY: Enable selective test execution and coverage reporting.
      CHANGES: Add markers for e2e, integration, slow. Configure coverage thresholds.

  - id: STORY-007-11
    title: ADF Test Fixtures
    points: 1
    files_to_create:
      - path: tests/fixtures/adf_fixtures.py
        intent: |
          WHAT: Reusable ADF document fixtures for integration and E2E tests.
          WHY: Standardize test data across ADF-related tests. Reduce duplication.
          RESPONSIBILITIES: Provide ADF_WITH_HARDBREAK, ADF_WITH_TABLE, ADF_WITH_MACRO fixtures.
          DEPENDENCIES: None - pure data fixtures.
          RELATED MODULES: Used by test_adf_surgical_e2e.py, test_adf_path_selection.py

total_files_to_create: 11
total_files_to_modify: 3
estimated_points: 33
coverage_target: 95%
target_modules:
  - src/page_operations/adf_editor.py
  - src/page_operations/page_operations.py
  - src/content_converter/markdown_converter.py
  - src/git_integration/conflict_resolver.py
  - src/git_integration/table_merge.py
