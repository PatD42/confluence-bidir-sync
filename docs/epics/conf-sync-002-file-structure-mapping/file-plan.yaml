# File Plan - Epic 002: File Structure & Mapping
# Maps implementation files to stories with intent descriptions

epic_id: conf-sync-002-file-structure-mapping
epic_title: File Structure & Mapping
version: 1
created: 2026-01-30

# Stories (implementation order)

stories:
  - id: story-002-01
    title: Filesafe filename conversion
    description: Convert Confluence page titles to filesystem-safe filenames
    acceptance_criteria:
      - Space to hyphen conversion
      - Colon to double-dash conversion
      - Case preservation
      - Collision detection
    files:
      - path: src/file_mapper/filesafe_converter.py
        operation: create
        intent: |
          WHAT: Static utility class for converting Confluence page titles to filesystem-safe filenames with case preservation and collision detection.
          WHY: Confluence allows spaces, colons, and special characters in titles that are invalid or problematic in filenames across different operating systems.
          RESPONSIBILITIES: Implements title-to-filename mapping (space→hyphen, colon→double-dash), validates generated filenames against OS constraints, detects naming collisions, provides bidirectional conversion for title recovery.
          DEPENDENCIES: No external dependencies (standard library only). Used by file_mapper.py for all filename operations.
          RELATED MODULES: file_mapper.py calls title_to_filename() before writing files; frontmatter_handler.py uses filename_to_title() for reverse conversion during file reads.

      - path: tests/unit/file_mapper/test_filesafe_converter.py
        operation: create
        intent: |
          WHAT: Unit tests for filesafe_converter.py covering all conversion rules, edge cases, and collision detection with 100% coverage target.
          WHY: Filename conversion is data-critical; incorrect conversions cause file loss, overwrites, or sync failures.
          RESPONSIBILITIES: Tests basic conversion (spaces, colons, case preservation), special character handling, multiple consecutive hyphens, collision detection, bidirectional conversion, OS-specific filename limits.
          DEPENDENCIES: pytest, filesafe_converter.py
          RELATED MODULES: Validates functionality used by file_mapper.py and frontmatter_handler.py.

  - id: story-002-02
    title: YAML frontmatter handler
    description: Parse and generate YAML frontmatter for markdown files
    acceptance_criteria:
      - Parse frontmatter from markdown
      - Validate required fields
      - Generate frontmatter from PageNode
      - Handle missing/malformed YAML
    files:
      - path: src/file_mapper/frontmatter_handler.py
        operation: create
        intent: |
          WHAT: Static utility class for parsing YAML frontmatter from markdown files and generating frontmatter from PageNode objects with validation.
          WHY: Frontmatter stores critical sync metadata (page_id, space_key, title, last_synced, confluence_version) that links local files to Confluence pages.
          RESPONSIBILITIES: Parses frontmatter and separates from content, validates required fields (page_id, space_key, title) against schema, generates frontmatter YAML from PageNode data, raises FrontmatterError for missing/invalid metadata.
          DEPENDENCIES: PyYAML for parsing; domain models (PageNode, LocalPage) for type contracts.
          RELATED MODULES: file_mapper.py calls parse_frontmatter() when reading files and generate_frontmatter() when writing; config_loader.py uses similar YAML parsing patterns.

      - path: tests/unit/file_mapper/test_frontmatter_handler.py
        operation: create
        intent: |
          WHAT: Unit tests for frontmatter_handler.py covering parsing, generation, validation, and error handling with 100% coverage target.
          WHY: Frontmatter corruption or missing metadata breaks sync state and causes data loss.
          RESPONSIBILITIES: Tests valid frontmatter parsing, generation round-trip, missing required fields, type mismatches, malformed YAML, empty frontmatter, extra unknown fields.
          DEPENDENCIES: pytest, frontmatter_handler.py, domain models
          RELATED MODULES: Validates functionality used by file_mapper.py for all file read/write operations.

  - id: story-002-03
    title: Configuration loader and validator
    description: Load and validate sync configuration from YAML
    acceptance_criteria:
      - Load config from .confluence-sync/config.yaml
      - Validate against JSON schema
      - Provide typed SyncConfig object
      - Handle missing/invalid config
    files:
      - path: src/file_mapper/config_loader.py
        operation: create
        intent: |
          WHAT: Static utility class for loading sync configuration from YAML, validating against JSON schema, and providing typed SyncConfig/SpaceConfig objects.
          WHY: Configuration drives all sync behavior (space keys, parent pages, local paths, exclusions); invalid config causes incorrect syncs or failures.
          RESPONSIBILITIES: Loads .confluence-sync/config.yaml, validates structure against 13-specs/schemas/domain/sync-config.json, checks required fields (version, spaces, space_key, parent_page_id, local_path), validates space_key pattern ^[A-Z0-9]+$, returns typed SyncConfig dataclass.
          DEPENDENCIES: PyYAML for parsing, jsonschema for validation, dataclasses for type safety.
          RELATED MODULES: file_mapper.py loads config at initialization; CLI commands use config_loader to validate user-provided config files.

      - path: tests/unit/file_mapper/test_config_loader.py
        operation: create
        intent: |
          WHAT: Unit tests for config_loader.py covering loading, validation, schema compliance, and error handling with 100% coverage target.
          WHY: Invalid config can cause data loss (wrong parent page), incorrect syncs (wrong space), or runtime failures.
          RESPONSIBILITIES: Tests valid config loading, missing file, invalid YAML syntax, missing required fields, invalid space_key pattern, duplicate space_key, schema validation, default values.
          DEPENDENCIES: pytest, config_loader.py, temporary files for test configs
          RELATED MODULES: Validates configuration consumed by file_mapper.py and all CLI commands.

  - id: story-002-04
    title: Hierarchy discovery via CQL
    description: Build page hierarchy tree using CQL queries
    acceptance_criteria:
      - Execute CQL query for child pages
      - Build recursive PageNode tree
      - Enforce 100 page limit per query
      - Handle pagination (up to limit)
    files:
      - path: src/file_mapper/hierarchy_builder.py
        operation: create
        intent: |
          WHAT: Class for building hierarchical PageNode trees from Confluence using CQL queries with recursive descent and page limit enforcement.
          WHY: Need to discover Confluence page hierarchy without persisting mapping.json; CQL provides efficient batch queries compared to REST pagination.
          RESPONSIBILITIES: Executes CQL query "parent=<pageID>" with limit 100, parses results into PageNode objects, recursively queries children to build tree, enforces total page limit per space, detects circular references, raises PageLimitExceededError when limit exceeded.
          DEPENDENCIES: APIWrapper.execute_cql() from Epic 001; domain.PageNode model.
          RELATED MODULES: file_mapper.py calls build_tree() during discover_pages() to get Confluence hierarchy; APIWrapper provides CQL execution via execute_cql() method.

      - path: src/confluence_client/api_wrapper.py
        operation: modify
        intent: |
          WHAT: Add execute_cql() method to APIWrapper for executing Confluence Query Language (CQL) searches with pagination support.
          WHY: HierarchyBuilder needs CQL to batch-query child pages efficiently (single query vs N REST calls for N children).
          RESPONSIBILITIES: Sends POST request to /rest/api/content/search with CQL query string, handles pagination (start, limit parameters), parses results to extract page metadata (id, title, version.number, version.when), returns list of page dictionaries, raises ConfluenceAPIError on failures.
          DEPENDENCIES: Existing APIWrapper.session for authentication; Confluence REST API /content/search endpoint.
          RELATED MODULES: hierarchy_builder.py calls execute_cql() to query page hierarchies; extends APIWrapper from Epic 001 with CQL capability.

      - path: tests/unit/file_mapper/test_hierarchy_builder.py
        operation: create
        intent: |
          WHAT: Unit tests for hierarchy_builder.py with mocked APIWrapper covering tree building, recursion, limit enforcement, and error handling (>90% coverage).
          WHY: Hierarchy building is complex (recursion, limits, CQL parsing); bugs cause incomplete syncs or missed pages.
          RESPONSIBILITIES: Tests single-level query, multi-level recursion, page limit enforcement, empty parent, circular reference detection, CQL query formatting, error propagation from API.
          DEPENDENCIES: pytest, unittest.mock, hierarchy_builder.py, mocked APIWrapper
          RELATED MODULES: Validates hierarchy building used by file_mapper.discover_pages() for all Confluence→local syncs.

      - path: tests/integration/test_cql_queries.py
        operation: create
        intent: |
          WHAT: Integration tests for CQL query execution against real Confluence test space validating query syntax, pagination, and result parsing.
          WHY: CQL syntax and API behavior must be verified against actual Confluence instance; mocks can't catch API contract changes.
          RESPONSIBILITIES: Tests real CQL query execution via APIWrapper.execute_cql(), validates returned page structure (id, title, version), tests pagination with start/limit parameters, validates query performance (<2s for 100 pages).
          DEPENDENCIES: pytest, real Confluence test instance (CONFSYNCTEST space), APIWrapper, test credentials
          RELATED MODULES: Validates execute_cql() implementation in api_wrapper.py used by hierarchy_builder.py for production queries.

  - id: story-002-05
    title: File mapper orchestration
    description: Orchestrate file mapping operations with atomic writes
    acceptance_criteria:
      - Discover pages from Confluence
      - Scan local files
      - Write pages with atomic operations
      - Read pages with frontmatter parsing
      - Rename files on title change
    files:
      - path: src/file_mapper/__init__.py
        operation: create
        intent: |
          WHAT: Module initialization exporting public classes (FileMapper, HierarchyBuilder, FilesafeConverter, FrontmatterHandler, ConfigLoader) and domain models.
          WHY: Provides clean public API for file_mapper module; controls what's importable by other modules and tests.
          RESPONSIBILITIES: Exports FileMapper (main class), utility classes, domain models (PageNode, LocalPage, SyncConfig), version info.
          DEPENDENCIES: All file_mapper submodules
          RELATED MODULES: CLI commands import from file_mapper; tests import module exports; other epics will extend file_mapper functionality.

      - path: src/file_mapper/file_mapper.py
        operation: create
        intent: |
          WHAT: Main orchestration class coordinating file mapping operations including hierarchy discovery, local scanning, atomic file writes, frontmatter handling, and file renaming.
          WHY: Centralizes complex file mapping logic with atomic guarantees; provides high-level API for sync operations while delegating to specialized utility classes.
          RESPONSIBILITIES: Loads config via ConfigLoader, discovers Confluence hierarchy via HierarchyBuilder.build_tree(), scans local files with frontmatter parsing via FrontmatterHandler, writes pages using two-phase atomic commit (temp write + atomic rename), reads local pages with frontmatter validation, renames files on title changes with old file cleanup, enforces initial sync validation (one side empty).
          DEPENDENCIES: HierarchyBuilder for CQL queries, FilesafeConverter for filenames, FrontmatterHandler for YAML, ConfigLoader for config, APIWrapper for Confluence access, MarkdownConverter from Epic 001 for content.
          RELATED MODULES: CLI sync command calls discover_pages() and write_page_to_local(); future Epic 003 (change detection) will call scan_local_files() and read_page_from_local() for comparison.

      - path: tests/unit/file_mapper/test_file_mapper.py
        operation: create
        intent: |
          WHAT: Unit tests for file_mapper.py orchestration logic with mocked dependencies covering discovery, scanning, atomic writes, and error handling (>90% coverage).
          WHY: FileMapper is the integration point for all file_mapper components; bugs affect all sync operations.
          RESPONSIBILITIES: Tests discover_pages() with mocked HierarchyBuilder, scan_local_files() with temp files, write_page_to_local() atomic operation, read_page_from_local() frontmatter parsing, rename_local_file() with cleanup, initial sync validation, error handling and rollback.
          DEPENDENCIES: pytest, unittest.mock, file_mapper.py, temp directories
          RELATED MODULES: Validates FileMapper orchestration used by CLI sync commands for all file operations.

      - path: tests/integration/test_file_operations.py
        operation: create
        intent: |
          WHAT: Integration tests for file_mapper operations using real filesystem (temp directories) and mocked APIWrapper validating atomic operations, frontmatter persistence, and rollback.
          WHY: File operations must be tested on real filesystem to catch OS-specific issues (permissions, atomic rename, disk full); unit tests with mocks insufficient.
          RESPONSIBILITIES: Tests atomic write success and rollback on failure, frontmatter round-trip (write + read), file rename with cleanup, directory creation for hierarchies, disk space handling, permission errors.
          DEPENDENCIES: pytest, file_mapper.py, temp directories (pytest tmp_path), mocked APIWrapper
          RELATED MODULES: Validates real filesystem behavior for FileMapper operations; complements unit tests with real I/O validation.

  - id: story-002-06
    title: End-to-end sync scenarios
    description: Full sync workflows with real Confluence test space
    acceptance_criteria:
      - Full pull sync (Confluence → Local)
      - Full push sync (Local → Confluence)
      - Bidirectional sync with changes
      - Title change detection and rename
      - Exclusion pattern support
      - Page limit exceeded error
    files:
      - path: tests/e2e/test_full_pull_sync.py
        operation: create
        intent: |
          WHAT: E2E test for complete pull sync workflow (Confluence → Local) using real test space with 15 pages validating hierarchy, frontmatter, filenames, and atomicity.
          WHY: Pull sync is primary user workflow; must validate end-to-end with real Confluence API and filesystem to catch integration issues.
          RESPONSIBILITIES: Sets up test Confluence space (CONFSYNCTEST) with 15 pages in 3-level hierarchy, executes FileMapper.discover_pages() + write_page_to_local() for all pages, verifies 15 markdown files created with correct hierarchy, validates all frontmatter has page_id and metadata, confirms filesafe filenames match titles, checks no temp files remain after sync.
          DEPENDENCIES: pytest, real Confluence test space, FileMapper, APIWrapper, temp directories
          RELATED MODULES: Validates complete workflow from HierarchyBuilder.build_tree() through FileMapper.write_page_to_local() to FrontmatterHandler.generate_frontmatter().

      - path: tests/e2e/test_full_push_sync.py
        operation: create
        intent: |
          WHAT: E2E test for complete push sync workflow (Local → Confluence) using 10 local markdown files without page_ids validating page creation, hierarchy, and frontmatter updates.
          WHY: Push sync enables local-first workflows; must validate page creation, parent-child relationships, and frontmatter injection.
          RESPONSIBILITIES: Creates 10 local markdown files without page_id in frontmatter, executes FileMapper.scan_local_files(), creates pages in Confluence via PageOperations from Epic 001, updates frontmatter with new page_ids, verifies all pages created in Confluence, validates hierarchy matches folder structure, confirms frontmatter updated with page_ids.
          DEPENDENCIES: pytest, real Confluence test space (empty parent page), FileMapper, PageOperations from Epic 001, temp directories
          RELATED MODULES: Validates FileMapper.scan_local_files() and integration with PageOperations.create_page(); tests frontmatter injection by FrontmatterHandler.

      - path: tests/e2e/test_bidirectional_sync.py
        operation: create
        intent: |
          WHAT: E2E test for bidirectional sync with non-conflicting changes (2 local edits, 2 remote edits on different pages) validating change detection and sync direction.
          WHY: Bidirectional sync is core value proposition; must handle simultaneous local and remote changes without conflicts.
          RESPONSIBILITIES: Sets up 5 synced pages, edits 2 local files, edits 2 different remote pages, detects local changes, pushes local changes to Confluence, detects remote changes, pulls remote changes to local, verifies all 4 changes applied correctly.
          DEPENDENCIES: pytest, real Confluence test space, FileMapper, PageOperations, temp directories
          RELATED MODULES: Validates change detection (future Epic 003) and integration between FileMapper, HierarchyBuilder, and PageOperations.

      - path: tests/e2e/test_title_change_detection.py
        operation: create
        intent: |
          WHAT: E2E test for detecting Confluence title changes and renaming local files with old file cleanup validating rename operation and frontmatter update.
          WHY: Title changes in Confluence must propagate to local filenames to maintain sync integrity; stale files cause confusion.
          RESPONSIBILITIES: Creates synced file "Old-Name.md", renames Confluence page to "New Name", executes sync to detect title mismatch, renames local file to "New-Name.md", updates frontmatter with new title, verifies old file deleted and new file exists.
          DEPENDENCIES: pytest, real Confluence test space, FileMapper, APIWrapper, temp directories
          RELATED MODULES: Validates FileMapper.rename_local_file() and FilesafeConverter round-trip conversion.

      - path: tests/e2e/test_exclusion_patterns.py
        operation: create
        intent: |
          WHAT: E2E test for page exclusion by page_id validating that excluded pages and descendants are not synced while other pages sync normally.
          WHY: Exclusion is critical for managing large spaces and avoiding sensitive content; must verify descendants also excluded.
          RESPONSIBILITIES: Sets up test space with "Archives" page (3 children), adds Archives page_id to config.exclude_page_ids, executes sync, verifies Archives and children NOT in local files, verifies other pages synced correctly.
          DEPENDENCIES: pytest, real Confluence test space, FileMapper, ConfigLoader, temp directories
          RELATED MODULES: Validates exclusion logic in HierarchyBuilder.build_tree() based on SyncConfig.exclude_page_ids.

      - path: tests/e2e/test_page_limit_exceeded.py
        operation: create
        intent: |
          WHAT: E2E test for page limit enforcement validating PageLimitExceededError raised when parent has >100 children and no files created.
          WHY: Page limit is MVP constraint (Epic 002); must fail gracefully with clear error message and recovery guidance.
          RESPONSIBILITIES: Sets up parent page with 100 child pages (at limit), attempts discover_pages(), verifies PageLimitExceededError raised with message mentioning limit, confirms no local files created (atomic failure).
          DEPENDENCIES: pytest, real Confluence test space (100+ pages), FileMapper
          RELATED MODULES: Validates page limit enforcement in HierarchyBuilder and error handling in FileMapper.

# Summary

total_files_to_create: 18
total_files_to_modify: 1

files_by_category:
  source_code: 6
  tests: 13
  modified: 1

implementation_order:
  - story-002-01: Filesafe conversion (foundation, no dependencies)
  - story-002-02: Frontmatter handler (foundation, PyYAML only)
  - story-002-03: Config loader (foundation, schema validation)
  - story-002-04: Hierarchy builder (depends on APIWrapper from Epic 001)
  - story-002-05: File mapper orchestration (depends on stories 01-04)
  - story-002-06: E2E tests (depends on all above)

epic_dependencies:
  from_epic_001:
    - src/confluence_client/api_wrapper.py (modified for CQL)
    - src/page_operations/page_operations.py (used in E2E push tests)
    - src/content_converter/markdown_converter.py (used for content conversion)
    - src/domain/errors.py (base error classes)

  provides_to_epic_003:
    - FileMapper.discover_pages() - Get Confluence state
    - FileMapper.scan_local_files() - Get local state
    - FileMapper.read_page_from_local() - Parse local files
    - PageNode, LocalPage models - Change detection data structures

test_coverage_targets:
  unit_tests: ">90%"
  integration_tests: "Key workflows (CQL, file ops, atomic)"
  e2e_tests: "All 6 acceptance criteria scenarios"

risks:
  - name: Filesystem atomicity on non-POSIX systems
    mitigation: Test on Windows, macOS, Linux; use os.replace() for cross-platform atomicity
  - name: CQL query performance with large hierarchies
    mitigation: 100 page limit enforced; Epic 005 addresses pagination
  - name: YAML frontmatter corruption
    mitigation: Schema validation, error handling, atomic writes with rollback
